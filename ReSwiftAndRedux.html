<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/VEN/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/VEN/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="iOS,Swift,翻译," />





  <link rel="alternate" href="/atom.xml" title="CepheusSun" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="随着 app 的发展， MVC 渐渐的满足不了业务的需求。大家都在探索各种各样的架构模式来适应这种情况，像是MVVM、VIPER、Riblets 等等。 他们都有各自的特点，但是都有同一个核心: 通过多向数据流将代码按照单一职责原则来划分代码。在多向数据流中，数据在各个模块中传递。
多向数据流并不一定是你想要的，反而，单向数据流才是我们更喜欢的数据传递方式。在这个 ReSwift 的教程中，你会学">
<meta property="og:type" content="article">
<meta property="og:title" content="用 ReSwift 实现 Redux 架构">
<meta property="og:url" content="http://www.CepheusSun.com/ReSwiftAndRedux.html">
<meta property="og:site_name" content="CepheusSun">
<meta property="og:description" content="随着 app 的发展， MVC 渐渐的满足不了业务的需求。大家都在探索各种各样的架构模式来适应这种情况，像是MVVM、VIPER、Riblets 等等。 他们都有各自的特点，但是都有同一个核心: 通过多向数据流将代码按照单一职责原则来划分代码。在多向数据流中，数据在各个模块中传递。
多向数据流并不一定是你想要的，反而，单向数据流才是我们更喜欢的数据传递方式。在这个 ReSwift 的教程中，你会学">
<meta property="og:image" content="http://ocg4av0wv.bkt.clouddn.com/2017-07-20-033011.jpg">
<meta property="og:image" content="http://ocg4av0wv.bkt.clouddn.com/2017-07-20-033331.jpg">
<meta property="og:image" content="http://ocg4av0wv.bkt.clouddn.com/2017-07-20-034323.jpg">
<meta property="og:image" content="http://ocg4av0wv.bkt.clouddn.com/2017-07-20-035231.jpg">
<meta property="og:image" content="http://ocg4av0wv.bkt.clouddn.com/2017-07-20-091710.jpg">
<meta property="og:image" content="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-014930.jpg">
<meta property="og:image" content="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-024808.jpg">
<meta property="og:image" content="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-025205.jpg">
<meta property="og:image" content="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-032618.jpg">
<meta property="og:image" content="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-032930.jpg">
<meta property="og:image" content="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-live.gif">
<meta property="og:image" content="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-065609.jpg">
<meta property="og:image" content="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-085643.jpg">
<meta property="og:image" content="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-091810.jpg">
<meta property="og:updated_time" content="2017-07-21T11:01:53.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="用 ReSwift 实现 Redux 架构">
<meta name="twitter:description" content="随着 app 的发展， MVC 渐渐的满足不了业务的需求。大家都在探索各种各样的架构模式来适应这种情况，像是MVVM、VIPER、Riblets 等等。 他们都有各自的特点，但是都有同一个核心: 通过多向数据流将代码按照单一职责原则来划分代码。在多向数据流中，数据在各个模块中传递。
多向数据流并不一定是你想要的，反而，单向数据流才是我们更喜欢的数据传递方式。在这个 ReSwift 的教程中，你会学">
<meta name="twitter:image" content="http://ocg4av0wv.bkt.clouddn.com/2017-07-20-033011.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":0,"b2t":false,"scrollpercent":true},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: "",
      labels: ""
    }
  };
</script>



  <link rel="canonical" href="http://www.CepheusSun.com/ReSwiftAndRedux.html"/>





  <title>用 ReSwift 实现 Redux 架构 | CepheusSun</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">CepheusSun</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Code for a better world.</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.CepheusSun.com/ReSwiftAndRedux.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CepheusSun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ocg4av0wv.bkt.clouddn.com/2017-07-18--3b9f0d5785eefeb7.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CepheusSun">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">用 ReSwift 实现 Redux 架构</h2>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2017-07-21T19:01:53+08:00">
                2017-07-21
              </time>
            
          </span>

          

          
            
          

          
          
             <span id="/ReSwiftAndRedux.html" class="leancloud_visitors" data-flag-title="用 ReSwift 实现 Redux 架构">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  5,578
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  23
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>随着 app 的发展， MVC 渐渐的满足不了业务的需求。大家都在探索各种各样的架构模式来适应这种情况，像是MVVM、VIPER、<a href="https://eng.uber.com/new-rider-app/">Riblets</a> 等等。 他们都有各自的特点，但是都有同一个核心: 通过多向数据流将代码按照单一职责原则来划分代码。在多向数据流中，数据在各个模块中传递。</p>
<p>多向数据流并不一定是你想要的，反而，单向数据流才是我们更喜欢的数据传递方式。在这个 ReSwift 的教程中，你会学到如何使用 ReSwift 来实现单向数据流，并完成一个状态驱动的游戏——<strong>MemoryTunes</strong></p>
<a id="more"></a>
<h2 id="什么是-ReSwift"><a href="#什么是-ReSwift" class="headerlink" title="什么是 ReSwift"></a>什么是 ReSwift</h2><p><a href="https://github.com/ReSwift/ReSwift">ReSwift</a> 是一个轻量级的框架，能够帮助你很轻松的去构建一个 Redux 架构的app。当然它是用Swift 实现的。</p>
<p>RxSwift 有以下四个模块</p>
<ul>
<li><strong>Views</strong>： 响应 <strong>Store</strong> 的改变，并且把他们展示在页面上。views 发出 <strong>Actions</strong>。</li>
<li><strong>Actions</strong>:发起app 种状态的改变。Action 是有 <strong>Reducer</strong> 操作的。</li>
<li><strong>Reducers</strong>: 直接改变程序的状态，这些状态由 <strong>Store</strong> 来保存。</li>
<li><strong>Store</strong>:保存当前的程序的状态。其他模块，比如说 <strong>Views</strong> 可以订阅这个状态，并且响应状态的改变。</li>
</ul>
<p>ReSwift 至少有以下这些优势:</p>
<ul>
<li><strong>很强的约束力</strong>：把一些代码放在不合适的地方往往具有很强的诱惑性，虽然这样写很方便。ReSwift 通过很强的约束力来避免这种情况。</li>
<li><strong>单向数据流</strong>：多向数据流的代码在阅读和debug上都可能变成一场灾难。一个改变可能会带来一系列的连锁反应。而单向数据流就能让程序的运行更加具有可预测性，也能够减少阅读这些代码的痛苦。</li>
<li><strong>容易测试</strong>：大多数的业务逻辑都在Reducer 中，这些都是纯的功能。</li>
<li><strong>复用性</strong>：ReSwift 中的每个组件—Store、Reducer、Action ，都是能在各个平台独立运行的，可以很轻松的在iOS、macOS、或者tvOS 中复用这些模块。</li>
</ul>
<h3 id="多向数据流-vs-单向数据流"><a href="#多向数据流-vs-单向数据流" class="headerlink" title="多向数据流 vs. 单向数据流"></a>多向数据流 vs. 单向数据流</h3><p>通过以下的几个例子，我们来理解一下什么是数据流。一个基于 VIPER 架构实现的程序就允许数据在其组件中多向传递。</p>
<center><br><br><img src="http://ocg4av0wv.bkt.clouddn.com/2017-07-20-033011.jpg" alt="VIPER 中的多向数据流"><br><br>VIPER 中的多向数据流</center>

<p>跟 ReSwift 中的数据传递方向比较一下：</p>
<center><br><br><img src="http://ocg4av0wv.bkt.clouddn.com/2017-07-20-033331.jpg" alt=""><br><br>ReSwift 中的单向数据流</center>

<p>可以看出来，数据是单向传递的，这么做，可以让程序中的数据传递更加清晰，也能够很轻松的定位到问题的所在。</p>
<h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>这是一个已经把整个框架差不多搭建起来的模版项目，包含了一些骨架代码，和库。<a href="https://github.com/CepheusSun/Translate/tree/master/demos/ReSwiftAndRedux">GitHub</a></p>
<p>首先需要做一些准备工作，首先就是要设置这个app最重要的部分:state</p>
<p>打开<strong>AppState.swift</strong> 文件，创建一个 AppState 的结构体:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AppState</span> : <span class="title">StateType</span></span>&#123;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个结构体定义了整个app的状态。</p>
<p>在创建包含所有的 AppState 的 <strong>Store</strong> 之前，还要创建一个主 Reducer</p>
<center><br><br><img src="http://ocg4av0wv.bkt.clouddn.com/2017-07-20-034323.jpg" alt=""><br><br></center>

<p>Reducer 是唯一可以直接改变 <strong>Store</strong> 中 <strong>AppState</strong> 的值的地方。只有 Action 可以驱动 Reducer 来改变当前程序的状态。而 Reducer 改变当前 AppState 的值，又取决于他接受到的 Action 类型。</p>
<blockquote>
<p>注意，在程序中只有一个 Store， 他也只有一个主 Reducer</p>
</blockquote>
<p>接下来在<strong>AppReducer.swift</strong> 中创建主 reducer：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">appReducer</span><span class="params">(action: Action, state: AppState?)</span></span> -&gt; <span class="type">AppState</span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="type">AppState</span>()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>appReducer</strong> 是一个接收 Action 并且返回改变之后的 AppState 的函数。参数 state 是程序当前的 state。 这个函数可以根据他接收的 Action 直接改变这个 状态。现在就可以很容易的创建一个 AppState 值了。</p>
<p>现在应该创建 Store 来保存 state 了。</p>
<center><br><br><img src="http://ocg4av0wv.bkt.clouddn.com/2017-07-20-035231.jpg" alt=""><br><br></center>

<p>Store 包含了整个程序当前的状态：这是 AppState 的一个实例。打开<strong>AppDelegate.swift</strong> ,在 impore UIkit 下面添加如下代码:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="keyword">var</span> store = <span class="type">Store</span>&lt;<span class="type">AppState</span>&gt;(reducer: appReducer, state: <span class="literal">nil</span>)</div></pre></td></tr></table></figure>
<p>这段代码通过 appReducer 创建了一个全局的变量store，appReducer 是这个 Store 的主 Reducer，他包含了接收到action的时候，store 应该怎么改变的规则。因为这是一些准备工作，所以只是传递了一个 nil state 进去。</p>
<p>编译运行，当然，什么都看不见。因为还没写啊！</p>
<h2 id="App-Routing"><a href="#App-Routing" class="headerlink" title="App Routing"></a>App Routing</h2><p>现在可以创建第一个实质的 state了，可是使用 IB 的导航，或者是 routing。</p>
<p>App 路由在所有的架构模式中都是一个挑战，在 ReSwift 中也是。在 MemoryTunes 中将使用很简单的方法来做这件事情，首先需要通过 enum 定义所有的终点，然后让 AppState 持有当前的终点。AppRouter 就会响应这个值的改变，达到路由的目的。</p>
<p>在 <strong>AppRouter.swift</strong> 中添加下面的代码：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">enum</span> <span class="title">RoutingDestination</span>: <span class="title">String</span> </span>&#123;</div><div class="line">  <span class="keyword">case</span> menu = <span class="string">"MenuTableViewController"</span></div><div class="line">  <span class="keyword">case</span> categories = <span class="string">"CategoriesTableViewController"</span></div><div class="line">  <span class="keyword">case</span> game = <span class="string">"GameViewController"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个枚举代表了app 中的所有 ViewController。</p>
<p>到现在，终于有能够放在你程序状态中的数据了。在这个例子里面，只有一个 state 结构体(AppState), 你也可以在这个 state 里面通过子状态的方法，将状态进行分类，这是一个很好的实践。</p>
<p>打开 <strong>RoutingState.swift</strong> 添加如下的子状态结构体：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RoutingState</span>: <span class="title">StateType</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> navigationState: <span class="type">RoutingDestination</span></div><div class="line">  </div><div class="line">  <span class="keyword">init</span>(navigationState: <span class="type">RoutingDestination</span> = .menu) &#123;</div><div class="line">    <span class="keyword">self</span>.navigationState = navigationState</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>RoutingState 包含了 navigationState， 这个东西，就是当前屏幕展示的界面。</p>
<blockquote>
<p>menu 是 navigationState 的默认值。如果没有制定的话，将它设置成这个app的最初状态。</p>
</blockquote>
<p>在 <strong>AppState.swift</strong> 中，添加如下代码:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> routingState: <span class="type">RoutingState</span></div></pre></td></tr></table></figure>
<p>现在 AppState 就有了 RoutingState 这个子状态。编译一下，会发现一个错误。</p>
<center><br><br><img src="http://ocg4av0wv.bkt.clouddn.com/2017-07-20-091710.jpg" alt=""><br><br></center>

<p><em>appReducer</em> 编译不过了！因为我们给 <em>AppState</em> 添加了 <em>routingState</em>，但是在初始化的时候并没有把这个东西传进去。现在还需要一个 reducer 来创建 <em>routingState</em></p>
<p>现在我们只有一个主 <strong>Reducer</strong>， 跟 state 类型，我们也可以通过 子Reducer 来将 Reducer 划分开来。</p>
<center><br><br><img src="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-014930.jpg" alt=""><br><br></center>

<p>在 <strong>RoutingReducer.swift</strong> 中添加下面的 <strong>Reducer</strong>：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">routingReducer</span><span class="params">(action: Action, state: RoutingState?)</span></span> -&gt; <span class="type">RoutingState</span> &#123;</div><div class="line">  <span class="keyword">let</span> state = state ?? <span class="type">RoutingState</span>()</div><div class="line">  <span class="keyword">return</span> state</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>跟 主 Reducer 差不多， <em>routionReducer</em> 根据接收到的 Action 改变状态，然后将这个状态返回。到现在，还没有创建 action 所以如果没有接收到 state 的话，就 new 一个 <em>RoutingState</em>，然后返回。</p>
<p>子 reducer 负责创造他们对应的 子状态。</p>
<p>现在回到 <strong>AppReducer.swift</strong> 去改变这个编译错误:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="type">AppState</span>(routingState: routingReducer(action: action, </div><div class="line">										 state: state?.routingState))</div></pre></td></tr></table></figure>
<p>给 AppState 的初始化方法中添加了对应的参数。其中的 action 和 state 都是由main reducer 传递进去的。</p>
<h3 id="订阅-subscribing"><a href="#订阅-subscribing" class="headerlink" title="订阅  subscribing"></a>订阅  subscribing</h3><p>还记得 RoutingState 里面那个默认的 state <code>.menu</code> 吗？他就是 app 默认的状态。只是你还没有订阅它。</p>
<p>任何的类都可以定于这个 store， 不仅仅是 <strong>View</strong>。当一个类订阅了这个 Store 之后，每次 state 的改变他都会得到通知。我们在 <em>AppRouter</em> 中订阅这个 Store， 然后收到通知之后，push 一个 Controller</p>
<p>打开 <strong>AppRouter.swift</strong> 然后重新写 <em>AppRouter</em></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AppRouter</span> </span>&#123;</div><div class="line">  </div><div class="line">  <span class="keyword">let</span> navigationController: <span class="type">UINavigationController</span></div><div class="line">  </div><div class="line">  <span class="keyword">init</span>(window: <span class="type">UIWindow</span>) &#123;</div><div class="line">    navigationController = <span class="type">UINavigationController</span>()</div><div class="line">    window.rootViewController = navigationController</div><div class="line">    </div><div class="line">    <span class="comment">// 1</span></div><div class="line">    store.subscribe(<span class="keyword">self</span>) &#123;</div><div class="line">      $<span class="number">0</span>.select &#123;</div><div class="line">        $<span class="number">0</span>.routingState</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">// 2</span></div><div class="line">  fileprivate <span class="function"><span class="keyword">func</span>  <span class="title">pushViewController</span><span class="params">(identifier: String, animated: Bool)</span></span> &#123;</div><div class="line">    <span class="keyword">let</span> viewController = instantiateViewController(identifier: identifier)</div><div class="line">    navigationController.pushViewController(viewController, animated: animated)</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  fileprivate <span class="function"><span class="keyword">func</span> <span class="title">instantiateViewController</span><span class="params">(identifier: String)</span></span> -&gt; <span class="type">UIViewController</span> &#123;</div><div class="line">    <span class="keyword">let</span> storyboard = <span class="type">UIStoryboard</span>(name: <span class="string">"Main"</span>, bundle: <span class="literal">nil</span>)</div><div class="line">    <span class="keyword">return</span> storyboard.instantiateViewController(withIdentifier: identifier)</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MARK: - StoreSubscriber</span></div><div class="line"><span class="comment">// 3</span></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">AppRouter</span> :<span class="title">StoreSubscriber</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">newState</span><span class="params">(state: RoutingState)</span></span> &#123;</div><div class="line">    <span class="comment">// 4</span></div><div class="line">    <span class="keyword">let</span> shouldsAnimate = navigationController.topViewController != <span class="literal">nil</span></div><div class="line">    pushViewController(identifier: state.navigationState.rawValue, animated: shouldsAnimate)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这段代码中，我们改了 AppRouter 这个类，然后添加了一个 extension。我们看看具体每一步都做了什么吧！</p>
<ol>
<li><em>AppState</em> 现在订阅了全局的 store， 在闭包里面， selct 表明正在订阅 routingState 的改变。</li>
<li><em>pushViewController</em> 用来初始化，并且 push 这个控制器。通过 identifier 加载的 StoryBoard 中的控制器。</li>
<li>让 <em>AppRouter</em> 响应 StoreSubscriber， 当 routingState 改变的时候，将新的值返回回来。</li>
<li>根控制器是不需要动画的，所以在这个地方判断一下根控制器。</li>
<li>当 state 发生改变，就可以去出 state.navigationState, push 出对应的 controller</li>
</ol>
<p>AppRouter 现在就就初始化 <em>menu</em> 然后将 <em>MenuTableViewController</em> push 出来</p>
<p>编译运行：</p>
<center><br><br><img src="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-024808.jpg" width="200"><br><br></center>

<p>现在 app 中就是 <em>MenuTableViewController</em> 了, 现在当然还是空的。毕竟我们还没有开始学 view。</p>
<h2 id="View"><a href="#View" class="headerlink" title="View"></a>View</h2><center><br><br><img src="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-025205.jpg" alt=""><br><br></center>

<p>任何东西都可能是一个 <em>StoreSubscriber</em>， 但是大多数情况下都是 view 层在响应状态的变化。现在是让 <em>MenuTableViewController</em> 来展示两个不同的 menu 了。</p>
<p>去 <strong>MenuState.swift</strong>， 创建对应的 Reducer</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MenuState</span>: <span class="title">StateType</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> menuTitles: [<span class="type">String</span>]</div><div class="line">  </div><div class="line">  <span class="keyword">init</span>() &#123;</div><div class="line">    menuTitles = [<span class="string">"NewGame"</span>, <span class="string">"Choose Category"</span>]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>MenuState</strong> 有一个 *menuTitles， 这个属性就是 tableView 的 title</p>
<p>在 <strong>MenuReducer.swift</strong> 中，创建这个 state 对应的 Reducer:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">menuReducer</span><span class="params">(action: Action, state: MenuState?)</span></span> -&gt; <span class="type">MenuState</span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="type">MenuState</span>()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为 MenuState 是静态的，所以不需要去处理状态的变化。所以这里只需要简单的返回一个新的 MenuState</p>
<p>回到 <strong>AppState.swift</strong> 中, 添加</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> meunState: <span class="type">MenuState</span></div></pre></td></tr></table></figure>
<p>编译又失败了，然后需要到 <strong>AppReducer.swift</strong> 中去修改这个编译错误。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="type">AppState</span>(routingState: routingReducer(action: action,</div><div class="line">                                  state: state?.routingState),</div><div class="line">      meunState: menuReducer(action: action, state: state?.meunState))</div></pre></td></tr></table></figure>
<p>现在有了 MenuState, 接下来就是要订阅它了。</p>
<p>先在打开 <strong>MenuTableViewController.swift</strong>, 然后将代码改成这样:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MenuTableViewController</span>: <span class="title">UITableViewController</span> </span>&#123;</div><div class="line">  <span class="comment">// 1</span></div><div class="line">  <span class="keyword">var</span> tableDataSource: <span class="type">TableDataSource</span>&lt;<span class="type">UITableViewCell</span>, <span class="type">String</span>&gt;?</div><div class="line">  </div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillAppear</span><span class="params">(<span class="number">_</span> animated: Bool)</span></span> &#123;</div><div class="line">    <span class="keyword">super</span>.viewWillAppear(animated)</div><div class="line">    <span class="comment">// 2</span></div><div class="line">    store.subscribe(<span class="keyword">self</span>) &#123;</div><div class="line">      $<span class="number">0</span>.select &#123;</div><div class="line">        $<span class="number">0</span>.menuState</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillDisappear</span><span class="params">(<span class="number">_</span> animated: Bool)</span></span> &#123;</div><div class="line">    <span class="keyword">super</span>.viewWillDisappear(animated)</div><div class="line">    <span class="comment">// 3</span></div><div class="line">    store.unsubscribe(<span class="keyword">self</span>)</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MARK: - StoreSubscriber</span></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MenuTableViewController</span>: <span class="title">StoreSubscriber</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">newState</span><span class="params">(state: MenuState)</span></span> &#123;</div><div class="line">    <span class="comment">// 4</span></div><div class="line">    tableDataSource = <span class="type">TableDataSource</span>(cellIdentifier: <span class="string">"TitleCell"</span>, models: state.menuTitles) &#123;</div><div class="line">      $<span class="number">0</span>.textLabel?.text = $<span class="number">1</span></div><div class="line">      $<span class="number">0</span>.textLabel?.textAlignment = .center</div><div class="line">      <span class="keyword">return</span> $<span class="number">0</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    tableView.dataSource = tableDataSource</div><div class="line">    tableView.reloadData()</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们来看看这段代码做了什么？</p>
<ol>
<li>TableDataSource 包含了UITableView data source 相关的东西。</li>
<li>订阅了 menuState</li>
<li>取消订阅</li>
<li>这段代码就是实现 UITableView 的代码，在这儿可以很明确的看到 state 是怎么变成 view 的。</li>
</ol>
<blockquote>
<p>可能已经发现了，ReSwift 使用了很多值类型变量，而不是对象类型。并且推荐使用声明式的 UI 代码。为什么呢？</p>
<p>StoreSubscriber 中定义的 newState 回调了状态的改变。你可能会通过这样的方法去接货这个值</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MenuTableViewController</span>: <span class="title">UITableViewController</span> </span>&#123;</div><div class="line">&gt;   <span class="keyword">var</span> currentMenuTitlesState: [<span class="type">String</span>]</div><div class="line">&gt;   ...</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>但是写声明式的 UI 代码，可以很明确的知道 state 是怎么转换成 View 的。在这个例子中的问题的 UITableView 并没有这样的API。这就是我写 TableDataSource 来桥接的原因。如果你感兴趣的话可以去看看这个 <strong>TableDataSource.swift</strong></p>
</blockquote>
<p>编译运行，就能够看到了:</p>
<center><br><br><img src="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-032618.jpg" width="200"><br><br></center>

<h2 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h2><center><br><br><img src="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-032930.jpg" alt=""><br><br></center>

<p>做好了 View 接下来就来写 <strong>Action</strong> 了。</p>
<p>Action 是 Store 中数据改变的原因。一个 Action 就是一个有很多变量结构体，这写变量也是这个 Action 的参数。 Reducer 处理一系列的 action， 然后改变 app 的状态。</p>
<p>我们现在先创建一个 Action， 打开 <strong>RoutingAction.swift</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RoutingAction</span>: <span class="title">Action</span> </span>&#123;</div><div class="line">  <span class="keyword">let</span> destination: <span class="type">RoutingDestination</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>RoutingAction</em> 改变当前的 routing 终点</p>
<p>现在，当 menu 的 cell 被点击的时候，派发一个 action。</p>
<p>在 <strong>MenuTableViewController.swift</strong> 中添加下面的代码:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, didSelectRowAt indexPath: IndexPath)</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> routeDestination: <span class="type">RoutingDestination</span> = .categories</div><div class="line">    <span class="keyword">switch</span> indexPath.row &#123;</div><div class="line">    <span class="keyword">case</span> <span class="number">0</span>: routeDestination = .game</div><div class="line">    <span class="keyword">case</span> <span class="number">1</span>: routeDestination = .categories</div><div class="line">    <span class="keyword">default</span>:<span class="keyword">break</span></div><div class="line">    &#125;</div><div class="line">    store.dispatch(<span class="type">RoutingAction</span>(destination: routeDestination))</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>这段代码，根据选择的 cell 设置不同的 routeDestination 然后用dispatch 方法派发出去。</p>
<p>这个 action 被派发出去了，但是，还没有被任何的 reducer 给支持。现在去 RoutingReducer.swift 然后做一下对应的修改。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> state = state ?? <span class="type">RoutingState</span>()</div><div class="line"></div><div class="line"><span class="keyword">switch</span> action &#123;</div><div class="line"><span class="keyword">case</span> <span class="keyword">let</span> routingAction <span class="keyword">as</span> <span class="type">RoutingAction</span>:</div><div class="line">  state.navigationState = routingAction.destination</div><div class="line"><span class="keyword">default</span>: <span class="keyword">break</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> state</div></pre></td></tr></table></figure>
<p>switch 语句用来判断是否传入的 action 是 RoutingAction。如果是，就修改 state 为这个 action 的 destination</p>
<p>编译运行，现在点击 item ， 就会对应的 push 出 controller。</p>
<h2 id="Updating-the-State"><a href="#Updating-the-State" class="headerlink" title="Updating the State"></a>Updating the State</h2><p>这样去实现导航可能是由瑕疵的。当你点击 “New Game” 的时候，<code>RoutingState</code> 的 <code>navigationState</code> 就会从<code>menu</code> 变成 <code>game</code>。 但是当你点击 controller 的返回按钮的时候，navigationState 却没有改变。</p>
<p>在 ReSwift 中，让状态跟 UI 同步是很重要的，但是这又是最容易搞忘的东西。特别是向上面那样，由 UIKit 自动控制的东西。</p>
<p>我们可以在 MenutableViewController 出现的时候更新一下这个状态。</p>
<p>在 <strong>MenuTableViewController.swift</strong> 的 <code>viewWillAppear</code>: 方法中，添加:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">store.dispatch(<span class="type">RoutingAction</span>(destination: .menu))</div></pre></td></tr></table></figure>
<p>这样就能够在上面的问题出现的时候解决这个问题。</p>
<p>运行一下呢？呃… 完全乱了。也可能会看到一个崩溃。</p>
<center><br><br><img src="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-live.gif" alt=""><br><br></center>

<p>打开 <strong>AppRouter.swift</strong>， 你会看到每次接收到一个新的 navigationState 的时候，都会调用 <code>pushViewController</code> 方法。也就是说，每次响应就会 push 一个 menu 出来！</p>
<p>所以我们还必须在 push 之前确定这个 controller 是不是正在屏幕中。所以我们修改一下 <code>pushViewController</code>  这个方法:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">fileprivate <span class="function"><span class="keyword">func</span>  <span class="title">pushViewController</span><span class="params">(identifier: String, animated: Bool)</span></span> &#123;</div><div class="line">	<span class="keyword">let</span> viewController = instantiateViewController(identifier: identifier)</div><div class="line">    <span class="keyword">let</span> newViewControllerType = type(of: viewController)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> currentVc = navigationController.topViewController &#123;</div><div class="line">      <span class="keyword">let</span> currentViewControllerType = type(of: currentVc)</div><div class="line">      <span class="keyword">if</span> currentViewControllerType == newViewControllerType &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    navigationController.pushViewController(viewController, animated: animated)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的方法中，通过 <code>type(of:)</code> 方法来避免当前的 topViewController 跟 要推出来的 Controller 进行对比。如果相等，就直接 <code>return</code> 。</p>
<p>编译运行，这时候，又一切正常了。</p>
<p>当 UI 发生变化的时候更新当前的状态是比较复杂的事情。这是写 ReSwift 的时候必须要解决的一件事情。还好他不是那么常见。</p>
<h2 id="Category"><a href="#Category" class="headerlink" title="Category"></a>Category</h2><p>现在，我们继续来实现  <em>CategoriesTableViewController</em> 这一部分跟之前的部分比起来更复杂一些。这个界面需要允许用户来选择音乐的类型，首先，我们在<strong>CategoriesState.swift</strong> 中添加响应的状态。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Category</span>: <span class="title">String</span> </span>&#123;</div><div class="line">  <span class="keyword">case</span> pop = <span class="string">"Pop"</span></div><div class="line">  <span class="keyword">case</span> electrinic = <span class="string">"Electronic"</span></div><div class="line">  <span class="keyword">case</span> rock = <span class="string">"Rock"</span></div><div class="line">  <span class="keyword">case</span> metal = <span class="string">"Metal"</span></div><div class="line">  <span class="keyword">case</span> rap = <span class="string">"Rap"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CategoriesState</span>: <span class="title">StateType</span> </span>&#123;</div><div class="line">  <span class="keyword">let</span> categories: [<span class="type">Category</span>]</div><div class="line">  <span class="keyword">var</span> currentCategorySelected: <span class="type">Category</span></div><div class="line">  </div><div class="line">  <span class="keyword">init</span>(currentCategory: <span class="type">Category</span>) &#123;</div><div class="line">    categories = [.pop, .electrinic, .rock, .metal, .rap]</div><div class="line">    currentCategorySelected = currentCategory</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个枚举定义了一些音乐的类型。CategoriesState 包含了一个数组的种类，以及当前选择的种类。</p>
<p>在 <strong>ChangeCategoryAction.swift</strong> 中添加这些代码:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ChangeCategoryAction</span>: <span class="title">Action</span> </span>&#123;</div><div class="line">  <span class="keyword">let</span> categoryIndex: <span class="type">Int</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里定义了对应的 action， 使用 categoryIndex 来寻找对应的音乐类型。</p>
<p>现在来实现 Reducer了。 这个 reducer 需要接受 ChangeCategoryAction 然后将新的 state 保存起来。打开 <strong>CategoryReducer.swift</strong>：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">struct</span> <span class="title">CategoriesReducerConstants</span> </span>&#123;</div><div class="line">  <span class="keyword">static</span> <span class="keyword">let</span> userDefaultCategoryKey = <span class="string">"currentCategoryKey"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">typealias</span> <span class="type">C</span> = <span class="type">CategoriesReducerConstants</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">categoriesReducer</span><span class="params">(action: Action, state: CategoriesState?)</span></span> -&gt; <span class="type">CategoriesState</span> &#123;</div><div class="line">  <span class="keyword">var</span> currentCategory: <span class="type">Category</span> = .pop</div><div class="line">  <span class="comment">// 1</span></div><div class="line">  <span class="keyword">if</span> <span class="keyword">let</span> loadedCategory = getCurrentCategoryStateFromUserDefaults() &#123;</div><div class="line">    currentCategory = loadedCategory</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">var</span> state = state ?? <span class="type">CategoriesState</span>(currentCategory: currentCategory)</div><div class="line">  </div><div class="line">  <span class="keyword">switch</span> action &#123;</div><div class="line">  <span class="keyword">case</span> <span class="keyword">let</span> changeCategoryAction <span class="keyword">as</span> <span class="type">ChangeCategoryAction</span>:</div><div class="line">    <span class="comment">// 2</span></div><div class="line">    <span class="keyword">let</span> newCategory = state.categories[changeCategoryAction.categoryIndex]</div><div class="line">    state.currentCategorySelected = newCategory</div><div class="line">    saveCurrentCategoryStateToUserdefaults(category: newCategory)</div><div class="line">  <span class="keyword">default</span>: <span class="keyword">break</span></div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> state</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 3</span></div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">getCurrentCategoryStateFromUserDefaults</span><span class="params">()</span></span> -&gt; <span class="type">Category</span>?</div><div class="line">&#123;</div><div class="line">  <span class="keyword">let</span> userDefaults = <span class="type">UserDefaults</span>.standard</div><div class="line">  <span class="keyword">let</span> rawValue = userDefaults.string(forKey: <span class="type">C</span>.userDefaultCategoryKey)</div><div class="line">  <span class="keyword">if</span> <span class="keyword">let</span> rawValue = rawValue &#123;</div><div class="line">    <span class="keyword">return</span> <span class="type">Category</span>(rawValue: rawValue)</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 4</span></div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">saveCurrentCategoryStateToUserdefaults</span><span class="params">(category: Category)</span></span> &#123;</div><div class="line">  <span class="keyword">let</span> userDefaults = <span class="type">UserDefaults</span>.standard</div><div class="line">  userDefaults.<span class="keyword">set</span>(category.rawValue, forKey: <span class="type">C</span>.userDefaultCategoryKey)</div><div class="line">  userDefaults.synchronize()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>跟其他的 Reducer 一样，这些方法实现了一下比较复杂的状态的改变，并且将选择之后的状态通过 Userdefault 持久化。</p>
<ol>
<li>从 UserDefault 中获取 category， 然后赋值给 CategoriesState</li>
<li>在接收到 ChangeCategoryAction 的时候更新状态，然后保存下来</li>
<li>从 Userdefault 中获取state</li>
<li>将 state 保存在 UserDefault 中</li>
</ol>
<p>3、4 中的两个方法都是功能很单一的方法，而且是全局的。你也可以把他们放在一个类或者结构体中。</p>
<p>接下来很自然的，就会需要在 AppState 中添加新的状态。打开 <strong>AppState.swift</strong> 然后添加对应的状态:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> categoriesState: <span class="type">CategoriesState</span></div></pre></td></tr></table></figure>
<p>然后去 <strong>AppReducer.swift</strong> 中去修改对应的错误</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="type">AppState</span>(routingState: routingReducer(action: action,</div><div class="line">                                             state: state?.routingState),</div><div class="line">                meunState: menuReducer(action: action, state: state?.meunState),</div><div class="line">      categoriesState: categoriesReducer(action: action, state: state?.categoriesState))</div></pre></td></tr></table></figure>
<p>现在还需要 View 了。现在需要在 CategoriesViewController 中去写这部分的 View</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CategoriesTableViewController</span>: <span class="title">UITableViewController</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> tableDataSource: <span class="type">TableDataSource</span>&lt;<span class="type">UITableViewCell</span>, <span class="type">Category</span>&gt;?</div><div class="line">  </div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillAppear</span><span class="params">(<span class="number">_</span> animated: Bool)</span></span> &#123;</div><div class="line">    <span class="keyword">super</span>.viewWillAppear(animated)</div><div class="line">    <span class="comment">//1</span></div><div class="line">    store.subscribe(<span class="keyword">self</span>) &#123;</div><div class="line">      $<span class="number">0</span>.select &#123;</div><div class="line">        $<span class="number">0</span>.categoriesState</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillDisappear</span><span class="params">(<span class="number">_</span> animated: Bool)</span></span> &#123;</div><div class="line">    <span class="keyword">super</span>.viewDidDisappear(animated)</div><div class="line">    store.unsubscribe(<span class="keyword">self</span>)</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, didSelectRowAt indexPath: IndexPath)</span></span> &#123;</div><div class="line">    <span class="comment">// 2</span></div><div class="line">    store.dispatch(<span class="type">ChangeCategoryAction</span>(categoryIndex: indexPath.row))</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">CategoriesTableViewController</span>: <span class="title">StoreSubscriber</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">newState</span><span class="params">(state: CategoriesState)</span></span> &#123;</div><div class="line">    tableDataSource = <span class="type">TableDataSource</span>(cellIdentifier: <span class="string">"CategoryCell"</span>, models: state.categories) &#123;</div><div class="line">      $<span class="number">0</span>.textLabel?.text = $<span class="number">1</span>.rawValue</div><div class="line">      <span class="comment">// 3</span></div><div class="line">      $<span class="number">0</span>.accessoryType = (state.currentCategorySelected == $<span class="number">1</span>) ? .checkmark : .<span class="keyword">none</span></div><div class="line">      <span class="keyword">return</span> $<span class="number">0</span></div><div class="line">    &#125;</div><div class="line">    tableView.dataSource = tableDataSource</div><div class="line">    tableView.reloadData()</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这部分的代码跟 MenuTableViewController 差不多。注释中标记的内容分别是：</p>
<ol>
<li>在 <code>viewWillAppear</code> 中订阅 categoriesState 的改变，然后在 <code>viewillDisappear</code> 中取消订阅。</li>
<li>将事件派发出去</li>
<li>标记选择的状态</li>
</ol>
<p>所有的东西都写好了，现在试一下！</p>
<center><br><br><img src="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-065609.jpg" width="200"><br><br></center>

<h2 id="异步任务"><a href="#异步任务" class="headerlink" title="异步任务"></a>异步任务</h2><p>怎么都跑不了这个话题，这在 ReSwift 也很方便。</p>
<p>场景:从 iTunes的 <a href="https://affiliate.itunes.apple.com/resources/documentation/itunes-store-web-service-search-api/?uo=8&amp;at=11ld4k">API</a> 中去获取照片。首先需要创建对应的 state， reducer 以及相关的 action.</p>
<p>打开 <strong>GameState.swift</strong> 添加</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">GameState</span>: <span class="title">StateType</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> memoryCards: [<span class="type">MemoryCard</span>]</div><div class="line">  <span class="comment">// 1</span></div><div class="line">  <span class="keyword">var</span> showLoading: <span class="type">Bool</span></div><div class="line">  <span class="comment">// 2</span></div><div class="line">  <span class="keyword">var</span> gameFinishied: <span class="type">Bool</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码定义了 Game 的状态。</p>
<ol>
<li>loading 的 菊花，是否存在</li>
<li>游戏是否结束</li>
</ol>
<p>接下来是Reducer <strong>GameReducer.swift</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">gameReducer</span><span class="params">(action: Action, state: GameState?)</span></span> -&gt; <span class="type">GameState</span> &#123;</div><div class="line">  <span class="keyword">let</span> state = state ?? <span class="type">GameState</span>(memoryCards: [],</div><div class="line">                                 showLoading: <span class="literal">false</span>,</div><div class="line">                                 gameFinishied: <span class="literal">false</span>)</div><div class="line">  <span class="keyword">return</span> state</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码就是简单的创建了一个 <em>GameState</em>, 稍后会再回到这个地方的。</p>
<p>在 <strong>AppState.swift</strong> 中，添加对应的状态</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> gameState: <span class="type">GameState</span></div></pre></td></tr></table></figure>
<p>修改 <strong>AppReducer.swift</strong> 中出现的编译错误</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="type">AppState</span>(routingState: routingReducer(action: action,</div><div class="line">                                               state: state?.routingState),</div><div class="line">                  meunState: menuReducer(action: action, state: state?.meunState),</div><div class="line">                  categoriesState: categoriesReducer(action: action, state: state?.categoriesState),</div><div class="line">                  gameState: gameReducer(action: action, state: state?.gameState))</div></pre></td></tr></table></figure>
<blockquote>
<p>发现了规律了吧，在每次写完 Action/Reducer/State之后应该做什么都是可见并且很简单的。这种情况，得益于ReSwift 的单向数据特效和严格的代码约束。只有 Reducer 能够改变 app 的 Store，只有 Action 能够触发这种响应。这样做能够让你知道在上面地方找代码，在什么地方做新功能。</p>
</blockquote>
<p>现在开始定义 Action， 这个 action 用来更新卡片。在 <strong>SetCardsAction.swift</strong>：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SetCardsAction</span>: <span class="title">Action</span> </span>&#123;</div><div class="line">  <span class="keyword">let</span> cardImageUrls: [<span class="type">String</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个 action 用来设置 GameState 中图片的URL</p>
<p>现在开始准备程序中第一个异步行为吧！在 <strong>FetchTumesAction.swift</strong> 中，添加下面的代码:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fetchTunes</span><span class="params">(state: AppState, store: Store&lt;AppState&gt;)</span></span> -&gt; <span class="type">FetchTunesAction</span> &#123;</div><div class="line">  iTunesAPI.searchFor(category: state.categoriesState.currentCategorySelected.rawValue) &#123;</div><div class="line">    store.dispatch(<span class="type">SetCardsAction</span>(cardImageUrls: $<span class="number">0</span>))</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="type">FetchTunesAction</span>()</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FetchTunesAction</span>: <span class="title">Action</span></span>&#123;&#125;</div></pre></td></tr></table></figure>
<p><code>fetchTunes</code>  通过 <code>itunesAPI</code> 获取了图片。然后在闭包中将结果派发出来。 ReSwift 中的异步任务就是这么简单。</p>
<p><code>fetchTunes</code> 返回一个 <code>FetchTunesAction</code>  这个 action 是用来验证请求的。</p>
<p>打开 <strong>OpenReducer.swift</strong> 然后添加对这两个 action 的支持。把 <code>gameReducer</code> 中的代码改成下面这样：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> state = state ?? <span class="type">GameState</span>(memoryCards: [],</div><div class="line">                                showLoading: <span class="literal">false</span>,</div><div class="line">                                gameFinishied: <span class="literal">false</span>)</div><div class="line"> <span class="keyword">switch</span> action &#123;</div><div class="line"> <span class="comment">// 1</span></div><div class="line"> <span class="keyword">case</span> <span class="number">_</span> <span class="keyword">as</span> <span class="type">FetchTunesAction</span>:</div><div class="line">   state = <span class="type">GameState</span>(memoryCards: [],</div><div class="line">                     showLoading: <span class="literal">true</span>,</div><div class="line">                     gameFinishied: <span class="literal">false</span>)</div><div class="line"> <span class="comment">// 2</span></div><div class="line"> <span class="keyword">case</span> <span class="keyword">let</span> setCardsAction <span class="keyword">as</span> <span class="type">SetCardsAction</span>:</div><div class="line">   state.memoryCards = generateNewCards(with: setCardsAction.cardImageUrls)</div><div class="line">   state.showLoading = <span class="literal">false</span></div><div class="line"> <span class="keyword">default</span>:<span class="keyword">break</span></div><div class="line"> &#125;</div><div class="line"> <span class="keyword">return</span> state</div></pre></td></tr></table></figure>
<p>这段代码，就是根据具体的 action 做不同的事情。</p>
<ol>
<li>FetchTunesAction, 设置 showLoading 为 true</li>
<li>SetCardsAction, 打乱卡片，然后将 showLoading 设置为 false。 generateNewCards 方法可以在 <strong>MemoryGameLogic.swift</strong> 中找到</li>
</ol>
<p>现在开始写 <strong>View</strong></p>
<p>在 <strong>CardCollectionViewCell.swift</strong> 中添加下面的方法:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">configCell</span><span class="params">(with cardState: MemoryCard)</span></span> &#123;</div><div class="line">  <span class="keyword">let</span> url = <span class="type">URL</span>(string: cardState.imageUrl)</div><div class="line">  <span class="comment">// 1</span></div><div class="line">  cardImageView.kf.setImage(with: url)</div><div class="line">  <span class="comment">// 2</span></div><div class="line">  cardImageView.alpha = cardState.isAlreadyGuessed || cardState.isFlipped ? <span class="number">1</span> : <span class="number">0</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>configCell</code> 这个方法做了下面两件事情:</p>
<ol>
<li>使用 Kingfisher 来缓存图片</li>
<li>判断是否展示图片</li>
</ol>
<p>下一步，实现 CollectionView。在 gameViewCotroller.swift 倒入 <code>import ReSwift</code> 然后在 <code>showGameFinishedAlert</code> 上面添加下面的代码:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> collectionDataSource: <span class="type">CollectionDataSource</span>&lt;<span class="type">CardCollectionViewCell</span>, <span class="type">MemoryCard</span>&gt;?</div><div class="line"> <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillAppear</span><span class="params">(<span class="number">_</span> animated: Bool)</span></span> &#123;</div><div class="line">   <span class="keyword">super</span>.viewWillAppear(animated)</div><div class="line">   store.subscribe(<span class="keyword">self</span>) &#123;</div><div class="line">     $<span class="number">0</span>.select &#123;</div><div class="line">       $<span class="number">0</span>.gameState</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"> <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillDisappear</span><span class="params">(<span class="number">_</span> animated: Bool)</span></span> &#123;</div><div class="line">   <span class="keyword">super</span>.viewWillDisappear(animated)</div><div class="line">   store.unsubscribe(<span class="keyword">self</span>)</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"> <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</div><div class="line">   <span class="comment">// 1</span></div><div class="line">   store.dispatch(fetchTunes)</div><div class="line">   collectionView.delegate = <span class="keyword">self</span></div><div class="line">   loadingIndicator.hidesWhenStopped = <span class="literal">true</span></div><div class="line">   </div><div class="line">   <span class="comment">// 2</span></div><div class="line">   collectionDataSource = <span class="type">CollectionDataSource</span>.<span class="keyword">init</span>(cellIdentifier: <span class="string">"CardCell"</span>, models: []) &#123;</div><div class="line">     $<span class="number">0</span>.configCell(with: $<span class="number">1</span>)</div><div class="line">     <span class="keyword">return</span> $<span class="number">0</span></div><div class="line">   &#125;</div><div class="line">   collectionView.dataSource = collectionDataSource</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>由于没有写 StoreSubscriber ，所以这里会有一点点的编译错误。我们先假设已经写了。这段代码，首先是订阅了取消订阅 gameState 然后:</p>
<ol>
<li>派发 fetchTunes 来获取图片</li>
<li>使用 CollectiondataSource  来配置 cell 相关信息。</li>
</ol>
<p>现在我们来添加 <code>StoreSubscriber</code> :</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">GameViewController</span>: <span class="title">StoreSubscriber</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">newState</span><span class="params">(state: GameState)</span></span> &#123;</div><div class="line">    collectionDataSource?.models = state.memoryCards</div><div class="line">    collectionView.reloadData()</div><div class="line">    <span class="comment">// 1</span></div><div class="line">    state.showLoading ? loadingIndicator.startAnimating() : loadingIndicator.stopAnimating()</div><div class="line">       <span class="comment">// 2</span></div><div class="line">    <span class="keyword">if</span> state.gameFinishied &#123;</div><div class="line">      showGameFinishedAlert()</div><div class="line">      store.dispatch(fetchTunes)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码实现了 state 改变的时候对应的变化。他会更新 dataSource</p>
<ol>
<li>更新 loading indicator 的状态。</li>
<li>当游戏结束时，弹窗</li>
</ol>
<p>现在，运行一下吧！</p>
<center><br><br><img src="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-085643.jpg" width="200"><br><br></center>

<h2 id="Play"><a href="#Play" class="headerlink" title="Play"></a>Play</h2><p>游戏的逻辑是： 让用户翻转两张卡片的时候，如果它们是一眼的，就让他们保持，如果不一样就翻回去。用户的任务是在尽可能少的尝试之后翻转所有的卡片。</p>
<p>现在需要一个翻转的事件。在 <strong>OpenCardAction.swift</strong> 中添加代码:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ReSwift</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FlipCardAction</span>: <span class="title">Action</span></span>&#123;</div><div class="line">  <span class="keyword">let</span> cardIndexToFlip: <span class="type">Int</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当卡片翻转的时候: FlipCardAction 使用 cardIndexToFlip 来更新 gameState 中的状态。</p>
<p>下一步修改 <code>gamereducer</code>  来支持这个 action。打开 <strong>GameReducer.swift</strong> 添加下面对应的case</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">case</span> <span class="keyword">let</span> flipCardAction <span class="keyword">as</span> <span class="type">FlipCardAction</span>:</div><div class="line">   state.memoryCards = flipCard(index: flipCardAction.cardIndexToFlip,</div><div class="line">                                memoryCards: state.memoryCards)</div><div class="line">state.gameFinishied = hasFinishedGame(cards: state.memoryCards)</div></pre></td></tr></table></figure>
<p>对 FlipCardAction 来说， flipCard 改变卡片的状态。hasFinishedGame 会在游戏结束的时候调用。两个方法都可以在 <strong>MemoryGameLogic.swift</strong> 中找到。</p>
<p>最后一个问题是在点击的时候，把翻转的 action 派发出去。</p>
<p>在 <strong>GameViewController.swift</strong> 中，找到 <code>UICollectionViewDelegate</code>  这个 extension。在 <code>collectionView(_:didSelectItemAt:)</code> 中添加:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">store.dispatch(<span class="type">FlipCardAction</span>(cardIndexToFlip: indexPath.row))</div></pre></td></tr></table></figure>
<p>当卡片被选择的时候，关联的<code>indexPath.row</code> 就会跟着 <code>FlipcardAction</code> 被派发出去.</p>
<p>再运行一下，就会发现！</p>
<center><br><br><img src="http://ocg4av0wv.bkt.clouddn.com/2017-07-21-091810.jpg" width="200"><br><br></center>



<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>模版项目已经完整项目都在 <a href="https://github.com/CepheusSun/Translate/tree/master/demos/ReSwiftAndRedux">GitHub</a> </p>
<p>ReSwift 不仅仅是我们今天提到的内容。他还以很多:</p>
<ul>
<li><strong>Middleware</strong>: 中间件。swift目前还没有很好的办法来做切面。但是 ReSwift 解决了这个问题。可以使用ReSwift 的 [Middleware] 特性来解决这个问题。他能够让你轻松的切面(logging, 统计， 缓存)。</li>
<li><strong>Routing</strong>： 在这个 app 中已经实现了自己的 Routing， 还有个更通用的解决方案<a href="https://github.com/ReSwift/ReSwift-Router">ReSwift-Routing</a> 单这在社区还是一个还没有完全解决的问题。说不定解决它的人就是你！</li>
<li><strong>Testing</strong>: ReSwift 或许是最方便测试的框架了。 Reducer 包含了你需要测试的所有代码。他们都是纯的功能函数。这种函数在接受了同一个input 总是返回同一个值，他们不回依赖于程序当前的状态。</li>
<li><strong>Debugging</strong>： ReSwift 的所有状态都在一个结构体中定义，并且是单向数据流的，debug 会非常的简单，甚至你还可以用 <a href="https://github.com/ReSwift/ReSwift-Recorder">ReSwift-Recorder</a> 来记录下导致 crash 的状态</li>
<li><strong>Persistence</strong>: 因为所有的状态都在一个地方，拓展和坚持都是很容易的事情。缓存离线的数据也是一个比较麻烦的架构问题，但是 ReSwift 解决了这个问题。</li>
<li><strong>others</strong>： Redux 架构并不是一个库，它是一种编程范式，你也可以自己实现一套，还有 <a href="https://github.com/BendingSpoons/katana-swift">Katana</a> 或者 <a href="https://github.com/ReduxKit/ReduxKit">ReduxKit</a> 也可以做这件事</li>
</ul>
<p>如果你想学习更多关于 ReSwift 的东西，可以看 ReSwift 作者 <a href="https://news.realm.io/news/benji-encz-unidirectional-data-flow-swift/">Benjamin Encz</a> 的演讲视频</p>
<p><a href="http://christiantietze.de/posts/2016/01/reswift-level-indirection/">Christian Tietze’s blog</a> 的博客上有很多有趣的例子。</p>
<p><strong>这篇文章翻译自Ray wenderlich <a href="https://www.raywenderlich.com/155815/reswift-tutorial-memory-game-app">ReSwift Tutorial: Memory Game App</a>]</strong></p>

      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="http://ocg4av0wv.bkt.clouddn.com/2017-07-22-qrcode_for_gh_ef8fdb22f3c3_430.jpg" alt="CepheusSun wechat" style="width: 200px; max-width: 100%;"/>
    <div>订阅我的公众号，每次更新我都不一定会告诉你！</div>
</div>


      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="http://ocg4av0wv.bkt.clouddn.com/wechat.png" alt="CepheusSun WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="http://ocg4av0wv.bkt.clouddn.com/alipay.png" alt="CepheusSun Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>本文作者：</strong>
      CepheusSun
    </li>
    <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://www.CepheusSun.com/ReSwiftAndRedux.html" title="用 ReSwift 实现 Redux 架构">http://www.CepheusSun.com/ReSwiftAndRedux.html</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
            <a href="/tags/Swift/" rel="tag"># Swift</a>
          
            <a href="/tags/翻译/" rel="tag"># 翻译</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/ShareExtension.html" rel="next" title="面向 Extension 开发 🌞 Share Extension">
                <i class="fa fa-chevron-left"></i> 面向 Extension 开发 🌞 Share Extension
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/一个人的敏捷开发.html" rel="prev" title="一个人的敏捷开发">
                一个人的敏捷开发 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>


    
    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://ocg4av0wv.bkt.clouddn.com/2017-07-18--3b9f0d5785eefeb7.jpg"
               alt="CepheusSun" />
          <p class="site-author-name" itemprop="name">CepheusSun</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">66</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">32</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/CepheusSun" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://juejin.im/user/5a308627f265da43271835ef" target="_blank" title="掘金">
                  
                    <i class="fa fa-fw fa-heart"></i>
                  
                  掘金
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/u/7f9d7158212f" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  简书
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/CepheusSun_" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/208883862/home?wvr=5&lf=reg" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://CepheusTeam.github.io/" title="CepheusTeam" target="_blank">CepheusTeam</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://kevincym.github.io/" title="KevinCym" target="_blank">KevinCym</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://maojianxiang.github.io/" title="小毛的博客" target="_blank">小毛的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://goileo.top/" title="Goileo" target="_blank">Goileo</a>
                </li>
              
            </ul>
          </div>
        

        <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=110 src="//music.163.com/outchain/player?type=0&id=964908739&auto=1&height=90"></iframe>

      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是-ReSwift"><span class="nav-number">1.</span> <span class="nav-text">什么是 ReSwift</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#多向数据流-vs-单向数据流"><span class="nav-number">1.1.</span> <span class="nav-text">多向数据流 vs. 单向数据流</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开始"><span class="nav-number">2.</span> <span class="nav-text">开始</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#App-Routing"><span class="nav-number">3.</span> <span class="nav-text">App Routing</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#订阅-subscribing"><span class="nav-number">3.1.</span> <span class="nav-text">订阅  subscribing</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#View"><span class="nav-number">4.</span> <span class="nav-text">View</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Action"><span class="nav-number">5.</span> <span class="nav-text">Action</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Updating-the-State"><span class="nav-number">6.</span> <span class="nav-text">Updating the State</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Category"><span class="nav-number">7.</span> <span class="nav-text">Category</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#异步任务"><span class="nav-number">8.</span> <span class="nav-text">异步任务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Play"><span class="nav-number">9.</span> <span class="nav-text">Play</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结束语"><span class="nav-number">10.</span> <span class="nav-text">结束语</span></a></li></ol></div>
            
          </div>
        </section>
      <!--/noindex-->
      

      
    </div>
  </aside>



        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CepheusSun</span>
</div>



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/VEN/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/VEN/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/VEN/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/VEN/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/VEN/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/VEN/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (search_path.endsWith("json")) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("3VegSLQBjr1EXkI6a2GR2aXY-gzGzoHsz", "bUW35k3am6UQE29tQY4kDeP5");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
        addVisit();
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });

    // 添加统计
    function addVisit() {
      var url2 = 'http://chaxun.1616.net/s.php?type=ip&output=json&callback=?&_=' + Math.random();
      $.getJSON(url2, function(data) {
        var $visitors = $(".leancloud_visitors");
        var url = $visitors.attr('id').trim();
        var title = $visitors.attr('data-flag-title').trim();
        // 声明一个 Todo 类型
        var Todo = AV.Object.extend('visit_list');
        // 新建一个 Todo 对象
        var todo = new Todo();
        var $visitors = $(".leancloud_visitors");
        var url = $visitors.attr('id').trim();
        var title = $visitors.attr('data-flag-title').trim();
        console.log(data);
        todo.set('ip_add', data.Ip);
        todo.set('ip_loc', data.Isp);
        todo.set('title', title);
        todo.set('url', url);
        todo.set('Browser' , data.Browser);
        todo.set('os' , data.OS);
        todo.save().then(function () {
        }, function(error) {
        }); 
      });
    }
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

</body>
</html>
